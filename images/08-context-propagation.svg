<?xml version="1.0" encoding="UTF-8"?>
<svg width="750" height="400" viewBox="0 0 750 400" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arr" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#00ADD8"/>
    </marker>
    <marker id="arrRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f97316"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="750" height="400" fill="#0d1117"/>

  <!-- Title -->
  <text x="375" y="30" font-family="Arial, sans-serif" font-size="18" fill="#c9d1d9" text-anchor="middle" font-weight="bold">Context Propagation in Go</text>

  <!-- Request comes in -->
  <g transform="translate(50, 60)">
    <rect x="0" y="0" width="100" height="50" rx="4" fill="#10b981" opacity="0.2" stroke="#10b981" stroke-width="2"/>
    <text x="50" y="22" font-family="Arial, sans-serif" font-size="11" fill="#10b981" text-anchor="middle" font-weight="bold">HTTP Request</text>
    <text x="50" y="40" font-family="Consolas, monospace" font-size="9" fill="#8b949e" text-anchor="middle">incoming</text>
  </g>

  <!-- Root context -->
  <g transform="translate(180, 60)">
    <rect x="0" y="0" width="140" height="50" rx="4" fill="#00ADD8" opacity="0.2" stroke="#00ADD8" stroke-width="2"/>
    <text x="70" y="22" font-family="Consolas, monospace" font-size="10" fill="#00ADD8" text-anchor="middle">ctx := r.Context()</text>
    <text x="70" y="40" font-family="Consolas, monospace" font-size="9" fill="#8b949e" text-anchor="middle">+ timeout, cancel</text>
  </g>

  <!-- Arrow -->
  <path d="M150 85 L180 85" stroke="#00ADD8" stroke-width="2" fill="none" marker-end="url(#arr)"/>

  <!-- Context tree -->
  <g transform="translate(350, 50)">
    <text x="175" y="0" font-family="Arial, sans-serif" font-size="12" fill="#8b949e" text-anchor="middle">Context flows through call stack</text>

    <!-- Handler -->
    <rect x="100" y="20" width="150" height="40" rx="4" fill="#1a3a4a" stroke="#00ADD8" stroke-width="2"/>
    <text x="175" y="45" font-family="Consolas, monospace" font-size="10" fill="#c9d1d9" text-anchor="middle">Handler(ctx, ...)</text>

    <!-- Arrow down -->
    <path d="M175 60 L175 80" stroke="#00ADD8" stroke-width="2" fill="none" marker-end="url(#arr)"/>

    <!-- Service -->
    <rect x="100" y="85" width="150" height="40" rx="4" fill="#1a4a5a" stroke="#00ADD8" stroke-width="2"/>
    <text x="175" y="110" font-family="Consolas, monospace" font-size="10" fill="#c9d1d9" text-anchor="middle">Service(ctx, ...)</text>

    <!-- Arrows down -->
    <path d="M140 125 L80 155" stroke="#00ADD8" stroke-width="2" fill="none" marker-end="url(#arr)"/>
    <path d="M210 125 L270 155" stroke="#00ADD8" stroke-width="2" fill="none" marker-end="url(#arr)"/>

    <!-- DB Call -->
    <rect x="20" y="160" width="120" height="40" rx="4" fill="#1a5a5a" stroke="#00ADD8" stroke-width="2"/>
    <text x="80" y="185" font-family="Consolas, monospace" font-size="10" fill="#c9d1d9" text-anchor="middle">db.QueryCtx(ctx)</text>

    <!-- External API -->
    <rect x="210" y="160" width="140" height="40" rx="4" fill="#1a5a5a" stroke="#00ADD8" stroke-width="2"/>
    <text x="280" y="185" font-family="Consolas, monospace" font-size="10" fill="#c9d1d9" text-anchor="middle">http.Do(req.WithCtx)</text>
  </g>

  <!-- Cancellation propagation -->
  <g transform="translate(50, 270)">
    <rect x="0" y="0" width="650" height="110" rx="4" fill="#161b22" stroke="#30363d"/>
    <text x="325" y="25" font-family="Arial, sans-serif" font-size="13" fill="#f97316" text-anchor="middle" font-weight="bold">Cancellation Propagates Down</text>

    <!-- Timeline -->
    <line x1="40" y1="60" x2="610" y2="60" stroke="#30363d" stroke-width="2"/>

    <!-- Client cancels -->
    <circle cx="80" cy="60" r="8" fill="#f97316"/>
    <text x="80" y="85" font-family="Consolas, monospace" font-size="9" fill="#f97316" text-anchor="middle">client disconnects</text>

    <!-- Context cancelled -->
    <circle cx="200" cy="60" r="8" fill="#f97316"/>
    <text x="200" y="85" font-family="Consolas, monospace" font-size="9" fill="#f97316" text-anchor="middle">ctx.Done()</text>

    <!-- DB stops -->
    <circle cx="350" cy="60" r="8" fill="#f97316"/>
    <text x="350" y="85" font-family="Consolas, monospace" font-size="9" fill="#f97316" text-anchor="middle">DB query aborts</text>

    <!-- API call stops -->
    <circle cx="500" cy="60" r="8" fill="#f97316"/>
    <text x="500" y="85" font-family="Consolas, monospace" font-size="9" fill="#f97316" text-anchor="middle">HTTP call cancelled</text>

    <!-- Propagation arrows -->
    <path d="M88 60 L192 60" stroke="#f97316" stroke-width="2" fill="none" marker-end="url(#arrRed)"/>
    <path d="M208 60 L342 60" stroke="#f97316" stroke-width="2" fill="none" marker-end="url(#arrRed)"/>
    <path d="M358 60 L492 60" stroke="#f97316" stroke-width="2" fill="none" marker-end="url(#arrRed)"/>

    <text x="325" y="105" font-family="Arial, sans-serif" font-size="10" fill="#8b949e" text-anchor="middle">No wasted work â€” all downstream operations stop immediately</text>
  </g>
</svg>
